<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <title>BCE Comics Pod | Blind Top 5</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0c10; color: #e8e8e8; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; padding-bottom: 96px; }

    .brand {
      border: 1px solid #2a2e45;
      border-radius: 14px;
      overflow: hidden;
      background: #141622;
      margin-bottom: 12px;
    }
    .brandTop {
      position: relative;
      padding: 14px 14px 12px 14px;
      min-height: 86px;
      background: #141622;
    }
    .brandBanner {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.35;
      filter: saturate(1.05) contrast(1.05);
      pointer-events: none;
    }
    .brandShade {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.75));
      pointer-events: none;
    }
    .brandRow {
      position: relative;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .brandLeft {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }
    .brandLogo {
      width: 46px;
      height: 46px;
      border-radius: 12px;
      border: 1px solid #2a2e45;
      object-fit: cover;
      background: #0f1120;
      flex: 0 0 auto;
    }
    .brandText { min-width: 0; }
    .brandTitle {
      font-weight: 900;
      font-size: 16px;
      line-height: 1.1;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brandSub {
      margin: 4px 0 0 0;
      opacity: 0.85;
      font-size: 12px;
      line-height: 1.2;
    }

    .pill {
      background: rgba(26,29,46,0.92);
      border: 1px solid #2a2e45;
      color: #e8e8e8;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .card { background: #141622; border: 1px solid #2a2e45; border-radius: 12px; padding: 12px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    input[type="file"] { color: #e8e8e8; max-width: 100%; }

    button {
      background: #2a57ff;
      color: #fff;
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 800;
      cursor: pointer;
      font-size: 16px;
      touch-action: manipulation;
    }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    .danger { background: #ff3b3b; }
    .ghost { background: #1a1d2e; border: 1px solid #2a2e45; }
    .sub { opacity: 0.85; font-size: 13px; line-height: 1.35; }

    .divider { height: 1px; background: #2a2e45; margin: 12px 0; }

    .panelTitle { display: flex; justify-content: space-between; gap: 10px; align-items: baseline; }
    .panelTitle .t { font-weight: 900; }

    .currentWrap {
      display: grid;
      gap: 10px;
    }
    .currentCard {
      background: #0f1120;
      border: 1px solid #2a2e45;
      border-radius: 14px;
      overflow: hidden;
      user-select: none;
    }
    .currentCard.dragging { opacity: 0.55; }
    .currentImg {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      display: block;
    }
    .currentMeta {
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .currentName {
      font-size: 13px;
      opacity: 0.9;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 520px;
    }

    .rankSlots { display: grid; gap: 10px; }
    .slot {
      background: #0f1120;
      border: 1px dashed #3a3f60;
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-columns: 92px 1fr auto;
      gap: 10px;
      align-items: center;
      min-height: 78px;
    }
    .slot.filled { border-style: solid; }
    .slot.dropReady { outline: 3px solid rgba(42,87,255,0.9); }
    .slotThumb {
      width: 92px;
      height: 62px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #2a2e45;
      display: block;
      background: #0b0c10;
    }
    .slotText { display: grid; gap: 3px; min-width: 0; }
    .slotRank { font-weight: 900; }
    .slotName {
      font-size: 13px;
      opacity: 0.9;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .slotHint { font-size: 12px; opacity: 0.7; }

    .thumbs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .thumbs img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; border: 1px solid #2a2e45; }

    .stickyBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 17, 32, 0.98);
      border-top: 1px solid #2a2e45;
      padding: 10px 12px;
      display: none;
      z-index: 9999;
    }
    .stickyRow {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .stickyMsg { font-size: 13px; opacity: 0.9; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="brand">
      <div class="brandTop">
        <div class="brandBanner" id="brandBanner"></div>
        <div class="brandShade"></div>
        <div class="brandRow">
          <div class="brandLeft">
            <img class="brandLogo" id="brandLogo" alt="BCE Comics Pod logo" />
            <div class="brandText">
              <p class="brandTitle">BCE Comics Pod</p>
              <p class="brandSub">Blind Top 5 ranking from 10 images</p>
            </div>
          </div>
          <div class="pill" id="status">Load 10 images</div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="controls">
          <input id="fileInput" type="file" accept="image/*" multiple />
          <button id="startBtn" disabled>Start</button>
          <button id="newRunBtn" class="ghost" disabled>New run</button>
          <button id="exportBtn" class="ghost" disabled>Export</button>
          <button id="resetBtn" class="danger" disabled>Reset</button>
          <span class="pill" id="progressPill">0 of 5 placed</span>
        </div>
        <div class="divider"></div>
        <div class="sub">
          Place the current image into any open rank slot. Drag onto a slot, or tap a slot to place.
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="panelTitle">
            <div class="t">Current image</div>
            <div class="pill" id="queuePill">0 of 5</div>
          </div>
          <div class="divider"></div>

          <div class="currentWrap">
            <div id="currentCard" class="currentCard" draggable="false" aria-label="Current image">
              <img id="currentImg" class="currentImg" alt="" />
              <div class="currentMeta">
                <div id="currentName" class="currentName">Waiting</div>
                <span class="pill" id="placeHint">Place it</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="panelTitle">
            <div class="t">Rank slots</div>
            <div class="pill" id="slotPill">Drop or tap</div>
          </div>
          <div class="divider"></div>
          <div id="rankSlots" class="rankSlots"></div>
        </div>

        <div class="card">
          <div class="panelTitle">
            <div class="t">All 10 loaded</div>
            <div class="pill" id="loadedPill">0 of 10</div>
          </div>
          <div class="divider"></div>
          <div class="thumbs" id="thumbs"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="stickyBar" id="stickyBar">
    <div class="stickyRow">
      <div class="stickyMsg" id="stickyMsg">Load 10 images</div>
      <div class="pill" id="stickyPill">0 of 5 placed</div>
    </div>
  </div>

  <script>
    // Root files in your repo
    const BRAND_LOGO_SRC = "./bce-logo.jpeg";
    const BRAND_BANNER_SRC = "./bce-banner.png";

    const brandLogoEl = document.getElementById("brandLogo");
    const brandBannerEl = document.getElementById("brandBanner");
    brandLogoEl.src = BRAND_LOGO_SRC;
    brandBannerEl.style.backgroundImage = `url('${BRAND_BANNER_SRC}')`;

    const fileInput = document.getElementById("fileInput");
    const startBtn = document.getElementById("startBtn");
    const newRunBtn = document.getElementById("newRunBtn");
    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");

    const statusEl = document.getElementById("status");
    const loadedPill = document.getElementById("loadedPill");
    const progressPill = document.getElementById("progressPill");
    const queuePill = document.getElementById("queuePill");
    const slotPill = document.getElementById("slotPill");
    const stickyBar = document.getElementById("stickyBar");
    const stickyMsg = document.getElementById("stickyMsg");
    const stickyPill = document.getElementById("stickyPill");

    const thumbsEl = document.getElementById("thumbs");
    const rankSlotsEl = document.getElementById("rankSlots");

    const currentCardEl = document.getElementById("currentCard");
    const currentImgEl = document.getElementById("currentImg");
    const currentNameEl = document.getElementById("currentName");
    const placeHintEl = document.getElementById("placeHint");

    let allImages = [];
    let pickedFive = [];
    let currentIndex = 0;

    // slots[0] is rank 1, slots[4] is rank 5
    let slots = [null, null, null, null, null];

    function setStatus(text) { statusEl.textContent = text; }

    function clearUrls(list) {
      for (const item of list) {
        if (item && item.url) URL.revokeObjectURL(item.url);
      }
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
      }
      return a;
    }

    function placedCount() {
      return slots.filter(Boolean).length;
    }

    function updateProgressUI() {
      const n = placedCount();
      progressPill.textContent = `${n} of 5 placed`;
      stickyPill.textContent = `${n} of 5 placed`;
      exportBtn.disabled = (n !== 5);
    }

    function updateQueueUI() {
      const shown = Math.min(currentIndex + 1, 5);
      queuePill.textContent = `${shown} of 5`;
    }

    function renderThumbs() {
      thumbsEl.innerHTML = "";
      for (const item of allImages) {
        const img = document.createElement("img");
        img.src = item.url;
        img.alt = item.name;
        thumbsEl.appendChild(img);
      }
      loadedPill.textContent = `${allImages.length} of 10`;
    }

    function renderSlots() {
      rankSlotsEl.innerHTML = "";

      for (let i = 0; i < 5; i++) {
        const rankNum = i + 1;
        const slot = document.createElement("div");
        slot.className = "slot";
        if (slots[i]) slot.classList.add("filled");

        slot.addEventListener("click", () => {
          slotPill.textContent = `Rank ${rankNum}`;
          placeIntoSlot(i);
        });

        slot.addEventListener("dragover", (e) => {
          if (slots[i]) return;
          if (!currentCardEl.draggable) return;
          e.preventDefault();
          slot.classList.add("dropReady");
        });

        slot.addEventListener("dragleave", () => {
          slot.classList.remove("dropReady");
        });

        slot.addEventListener("drop", (e) => {
          e.preventDefault();
          slot.classList.remove("dropReady");
          placeIntoSlot(i);
        });

        const thumb = document.createElement("img");
        thumb.className = "slotThumb";
        if (slots[i]) {
          thumb.src = slots[i].url;
          thumb.alt = slots[i].name;
        } else {
          thumb.alt = "";
        }

        const text = document.createElement("div");
        text.className = "slotText";

        const rank = document.createElement("div");
        rank.className = "slotRank";
        rank.textContent = `Rank ${rankNum}`;

        const name = document.createElement("div");
        name.className = "slotName";
        name.textContent = slots[i] ? slots[i].name : "Empty";

        const hint = document.createElement("div");
        hint.className = "slotHint";
        hint.textContent = slots[i] ? "Locked" : "Tap or drop current image here";

        text.appendChild(rank);
        text.appendChild(name);
        text.appendChild(hint);

        const right = document.createElement("div");
        right.className = "pill";
        right.textContent = slots[i] ? "Filled" : "Open";

        slot.appendChild(thumb);
        slot.appendChild(text);
        slot.appendChild(right);

        rankSlotsEl.appendChild(slot);
      }
    }

    function showCurrent() {
      const done = placedCount() === 5;

      if (done) {
        setStatus("Done");
        stickyMsg.textContent = "Done. Export ready.";
        currentCardEl.draggable = false;
        currentCardEl.classList.remove("dragging");
        currentImgEl.src = "";
        currentImgEl.alt = "";
        currentNameEl.textContent = "Finished";
        placeHintEl.textContent = "Export";
        return;
      }

      const item = pickedFive[currentIndex];
      if (!item) {
        setStatus("Place your top 5");
        stickyMsg.textContent = "Place the current image";
        return;
      }

      setStatus("Place your top 5");
      stickyMsg.textContent = "Place the current image";
      currentImgEl.src = item.url;
      currentImgEl.alt = item.name;
      currentNameEl.textContent = item.name;
      placeHintEl.textContent = "Drag or tap a slot";
      currentCardEl.draggable = true;

      updateQueueUI();
    }

    function advance() {
      currentIndex += 1;
      showCurrent();
    }

    function placeIntoSlot(slotIndex) {
      if (slots[slotIndex]) return;
      if (placedCount() === 5) return;

      const item = pickedFive[currentIndex];
      if (!item) return;

      slots[slotIndex] = item;
      renderSlots();
      updateProgressUI();
      advance();
    }

    async function requestPortraitLock() {
      try {
        if (!screen.orientation || !screen.orientation.lock) return;
        await screen.orientation.lock("portrait");
      } catch (_) {
        // ignore
      }
    }

    function startRun() {
      requestPortraitLock();

      pickedFive = shuffle(allImages).slice(0, 5);
      currentIndex = 0;
      slots = [null, null, null, null, null];

      stickyBar.style.display = "block";
      stickyMsg.textContent = "Place the current image";

      setStatus("Place your top 5");
      newRunBtn.disabled = false;
      resetBtn.disabled = false;
      exportBtn.disabled = true;

      renderSlots();
      updateProgressUI();
      updateQueueUI();
      showCurrent();
    }

    function newRun() {
      if (allImages.length !== 10) return;
      startRun();
    }

    function resetAll() {
      clearUrls(allImages);
      allImages = [];
      pickedFive = [];
      currentIndex = 0;
      slots = [null, null, null, null, null];

      fileInput.value = "";
      thumbsEl.innerHTML = "";
      rankSlotsEl.innerHTML = "";

      loadedPill.textContent = "0 of 10";
      progressPill.textContent = "0 of 5 placed";
      queuePill.textContent = "0 of 5";
      slotPill.textContent = "Drop or tap";

      stickyBar.style.display = "none";
      stickyMsg.textContent = "Load 10 images";
      stickyPill.textContent = "0 of 5 placed";

      setStatus("Load 10 images");

      currentCardEl.draggable = false;
      currentImgEl.src = "";
      currentImgEl.alt = "";
      currentNameEl.textContent = "Waiting";
      placeHintEl.textContent = "Place it";

      startBtn.disabled = true;
      newRunBtn.disabled = true;
      exportBtn.disabled = true;
      resetBtn.disabled = true;
    }

    currentCardEl.addEventListener("dragstart", (e) => {
      if (!currentCardEl.draggable) {
        e.preventDefault();
        return;
      }
      currentCardEl.classList.add("dragging");
      e.dataTransfer.setData("text/plain", "current");
    });

    currentCardEl.addEventListener("dragend", () => {
      currentCardEl.classList.remove("dragging");
      for (const el of document.querySelectorAll(".slot")) el.classList.remove("dropReady");
    });

    function buildExportCanvas() {
      const width = 1080;
      const height = 1920;
      const padding = 56;

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");

      const bg = ctx.createLinearGradient(0, 0, 0, height);
      bg.addColorStop(0, "#0b0c10");
      bg.addColorStop(1, "#141622");
      ctx.fillStyle = bg;
      ctx.fillRect(0, 0, width, height);

      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "900 64px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("BCE COMICS POD", padding, 120);

      ctx.fillStyle = "rgba(255,255,255,0.80)";
      ctx.font = "700 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Blind Top 5", padding, 172);

      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padding, 206);
      ctx.lineTo(width - padding, 206);
      ctx.stroke();

      const cardW = width - padding * 2;
      const cardH = 280;
      const gap = 34;
      let y = 250;

      return { canvas, ctx, width, height, padding, cardW, cardH, gap, y };
    }

    function drawRoundedRect(ctx, x, y, w, h, r) {
      const rr = Math.min(r, w / 2, h / 2);
      ctx.beginPath();
      ctx.moveTo(x + rr, y);
      ctx.arcTo(x + w, y, x + w, y + h, rr);
      ctx.arcTo(x + w, y + h, x, y + h, rr);
      ctx.arcTo(x, y + h, x, y, rr);
      ctx.arcTo(x, y, x + w, y, rr);
      ctx.closePath();
    }

    function loadImageFromUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function exportRanking() {
      if (placedCount() !== 5) return;

      exportBtn.disabled = true;
      exportBtn.textContent = "Exporting";

      const layout = buildExportCanvas();
      const { canvas, ctx, padding, cardW, cardH, gap } = layout;
      let y = layout.y;

      for (let i = 0; i < 5; i++) {
        const item = slots[i];
        const rankNum = i + 1;

        ctx.fillStyle = "rgba(15,17,32,0.98)";
        drawRoundedRect(ctx, padding, y, cardW, cardH, 22);
        ctx.fill();

        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.font = "900 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(`Rank ${rankNum}`, padding + 26, y + 66);

        if (item) {
          const img = await loadImageFromUrl(item.url);

          const thumbSize = 200;
          const tx = padding + 26;
          const ty = y + 92;

          drawRoundedRect(ctx, tx, ty, thumbSize, thumbSize, 18);
          ctx.save();
          ctx.clip();

          const ir = img.width / img.height;
          let dw = thumbSize, dh = thumbSize;
          let sx = 0, sy = 0, sw = img.width, sh = img.height;

          if (ir > 1) {
            sh = img.height;
            sw = img.height;
            sx = Math.floor((img.width - sw) / 2);
          } else {
            sw = img.width;
            sh = img.width;
            sy = Math.floor((img.height - sh) / 2);
          }

          ctx.drawImage(img, sx, sy, sw, sh, tx, ty, dw, dh);
          ctx.restore();

          ctx.fillStyle = "rgba(255,255,255,0.85)";
          ctx.font = "700 32px system-ui, -apple-system, Segoe UI, Roboto, Arial";

          const maxW = cardW - (26 + thumbSize + 26 + 26);
          const textX = tx + thumbSize + 26;
          const textY = ty + 60;

          const name = item.name || `Image ${rankNum}`;
          const clipped = clipText(ctx, name, maxW);
          ctx.fillText(clipped, textX, textY);

          ctx.fillStyle = "rgba(255,255,255,0.55)";
          ctx.font = "600 26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillText("Top 5 selection", textX, textY + 44);
        }

        y += cardH + gap;
      }

      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png", 1.0));

      const file = new File([blob], "bce-top-5.png", { type: "image/png" });

      try {
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files: [file], title: "BCE Comics Pod", text: "Blind Top 5" });
        } else {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "bce-top-5.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      } catch (_) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "bce-top-5.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      exportBtn.textContent = "Export";
      exportBtn.disabled = false;
    }

    function clipText(ctx, text, maxWidth) {
      if (ctx.measureText(text).width <= maxWidth) return text;
      const ellipsis = "â€¦";
      let t = text;
      while (t.length > 0 && ctx.measureText(t + ellipsis).width > maxWidth) {
        t = t.slice(0, -1);
      }
      return t + ellipsis;
    }

    fileInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);

      clearUrls(allImages);
      allImages = files.slice(0, 10).map((f, idx) => ({
        id: `${Date.now()}-${idx}`,
        name: f.name || `Image ${idx + 1}`,
        file: f,
        url: URL.createObjectURL(f)
      }));

      renderThumbs();

      if (allImages.length === 10) {
        startBtn.disabled = false;
        setStatus("Ready");
      } else {
        startBtn.disabled = true;
        setStatus(`Loaded ${allImages.length}. Need 10`);
      }

      newRunBtn.disabled = true;
      exportBtn.disabled = true;
      resetBtn.disabled = (allImages.length === 0);

      pickedFive = [];
      currentIndex = 0;
      slots = [null, null, null, null, null];
      renderSlots();

      stickyBar.style.display = "none";
      stickyMsg.textContent = "Load 10 images";
      updateProgressUI();

      currentCardEl.draggable = false;
      currentImgEl.src = "";
      currentImgEl.alt = "";
      currentNameEl.textContent = "Waiting";
      placeHintEl.textContent = "Place it";

      queuePill.textContent = "0 of 5";
    });

    startBtn.addEventListener("click", async () => {
      await requestPortraitLock();
      stickyBar.style.display = "block";
      startRun();
    });

    newRunBtn.addEventListener("click", async () => {
      await requestPortraitLock();
      newRun();
    });

    exportBtn.addEventListener("click", exportRanking);
    resetBtn.addEventListener("click", resetAll);

    function startRun() {
      pickedFive = shuffle(allImages).slice(0, 5);
      currentIndex = 0;
      slots = [null, null, null, null, null];

      setStatus("Place your top 5");
      stickyMsg.textContent = "Place the current image";
      stickyPill.textContent = "0 of 5 placed";

      newRunBtn.disabled = false;
      resetBtn.disabled = false;
      exportBtn.disabled = true;

      renderSlots();
      updateProgressUI();
      updateQueueUI();
      showCurrent();
    }
  </script>
</body>
</html>
