<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c10" />
  <title>BCE Comics Pod | Blind Top 5</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0c10; color: #e8e8e8; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 14px; padding-bottom: 96px; }

    .pill {
      background: rgba(26,29,46,0.92);
      border: 1px solid #2a2e45;
      color: #e8e8e8;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    button {
      background: #2a57ff;
      color: #fff;
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 900;
      cursor: pointer;
      font-size: 16px;
      touch-action: manipulation;
    }
    button:disabled { opacity: 0.45; cursor: not-allowed; }
    .danger { background: #ff3b3b; }
    .ghost { background: #1a1d2e; border: 1px solid #2a2e45; }

    input[type="file"] { color: #e8e8e8; max-width: 100%; }

    .card { background: #141622; border: 1px solid #2a2e45; border-radius: 12px; padding: 12px; }
    .divider { height: 1px; background: #2a2e45; margin: 12px 0; }
    .sub { opacity: 0.85; font-size: 13px; line-height: 1.35; }

    .stickyBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 17, 32, 0.98);
      border-top: 1px solid #2a2e45;
      padding: 10px 12px;
      display: none;
      z-index: 9999;
    }
    .stickyRow {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .stickyMsg { font-size: 13px; opacity: 0.9; }

    /* Banner header */
    .hero {
      border: 1px solid #2a2e45;
      border-radius: 14px;
      overflow: hidden;
      background: #141622;
      margin-bottom: 12px;
    }
    .heroBanner {
      position: relative;
      height: 160px;
      background: #0f1120;
      background-size: cover;
      background-position: center;
    }
    @media (min-width: 650px) { .heroBanner { height: 190px; } }
    @media (min-width: 980px) { .heroBanner { height: 220px; } }

    .heroShade {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.86));
    }

    .heroContent {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .heroLeft { display: flex; gap: 12px; align-items: flex-end; min-width: 0; }
    .heroLogo {
      width: 96px;
      height: 96px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      object-fit: cover;
      background: rgba(15,17,32,0.75);
      flex: 0 0 auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    @media (min-width: 650px) { .heroLogo { width: 112px; height: 112px; } }

    .heroText { min-width: 0; }
    .heroTitle {
      margin: 0;
      font-weight: 1000;
      font-size: 22px;
      line-height: 1.1;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 6px 22px rgba(0,0,0,0.6);
    }
    .heroSub {
      margin: 6px 0 0 0;
      opacity: 0.92;
      font-size: 13px;
      text-shadow: 0 6px 22px rgba(0,0,0,0.6);
    }

    /* Collapsible controls */
    .controlsTop {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .controlsLeft { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .controlsRight { display: flex; gap: 10px; align-items: center; }
    .controlsBody { margin-top: 10px; display: none; }
    .controlsBody.open { display: block; }
    .controlsRow { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    /* Main layout: rank slots (left) and current (right) */
    .rightCol {
      display: grid;
      gap: 12px;
      grid-template-columns: minmax(170px, 44vw) 1fr;
      align-items: start;
    }
    @media (min-width: 980px) {
      .rightCol { grid-template-columns: 380px 1fr; }
    }

    .panelTitle { display: flex; justify-content: space-between; gap: 10px; align-items: baseline; }
    .panelTitle .t { font-weight: 1000; }

    .currentCard {
      background: #0f1120;
      border: 1px solid #2a2e45;
      border-radius: 14px;
      overflow: hidden;
      user-select: none;
    }
    .currentCard.dragging { opacity: 0.55; }
    .currentImg {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: contain;
      background: #0b0c10;
      display: none;
    }
    .currentMeta {
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .rankSlots { display: grid; gap: 10px; }
    .slot {
      background: #0f1120;
      border: 1px dashed #3a3f60;
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-columns: 64px 1fr auto;
      gap: 10px;
      align-items: center;
      min-height: 86px;
    }
    .slot.filled { border-style: solid; }
    .slot.dropReady { outline: 3px solid rgba(42,87,255,0.9); }
    .slotThumb {
      width: 64px;
      aspect-ratio: 2 / 3;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid #2a2e45;
      display: block;
      background: #0b0c10;
    }
    .slotText { display: grid; gap: 3px; min-width: 0; }
    .slotRank { font-weight: 1000; }
    .slotHint { font-size: 12px; opacity: 0.7; }

    /* Uploads in More panel */
    .uploadsGrid { display: grid; gap: 8px; grid-template-columns: repeat(3, 1fr); }
    @media (min-width: 650px) { .uploadsGrid { grid-template-columns: repeat(6, 1fr); } }
    @media (min-width: 980px) { .uploadsGrid { grid-template-columns: repeat(10, 1fr); } }

    .uThumb {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #2a2e45;
      background: #0b0c10;
      display: block;
    }

    .currentName { display: none; }
    .slotName { display: none; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="hero">
      <div class="heroBanner" id="heroBanner">
        <div class="heroShade"></div>
        <div class="heroContent">
          <div class="heroLeft">
            <img class="heroLogo" id="heroLogo" alt="BCE Comics Pod logo" />
            <div class="heroText">
              <p class="heroTitle">BCE Comics Pod</p>
              <p class="heroSub">Blind Top 5 ranking from your upload set</p>
            </div>
          </div>
          <div class="pill" id="status">Load images</div>
        </div>
      </div>
    </div>

    <div class="card" id="controlsCard">
      <div class="controlsTop">
        <div class="controlsLeft">
          <input id="fileInput" type="file" accept="image/*" multiple />
          <span class="pill" id="loadedPill">0 loaded</span>
        </div>

        <div class="controlsRight">
          <button id="startBtn" disabled>Start</button>
          <button id="toggleControlsBtn" class="ghost" disabled>More</button>
        </div>
      </div>

      <div id="controlsBody" class="controlsBody">
        <div class="controlsRow">
          <button id="newRunBtn" class="ghost" disabled>New run</button>
          <button id="undoBtn" class="ghost" disabled>Undo</button>
          <button id="exportBtn" class="ghost" disabled>Export</button>
          <button id="resetBtn" class="danger" disabled>Reset</button>
        </div>

        <div class="controlsRow">
          <span class="pill" id="progressPill">0 of 5 placed</span>
          <span class="pill" id="queuePill">0 of 5</span>
          <span class="pill" id="slotPill">Drop or tap</span>
        </div>

        <div class="divider"></div>

        <div class="sub">
          Blind flow. One cover shows at a time. Place it into any open slot. Next cover appears after placement.
        </div>

        <div class="divider"></div>

        <div class="panelTitle">
          <div class="t">Uploads</div>
          <div class="pill" id="uploadsCount">0</div>
        </div>
        <div style="height:10px"></div>
        <div id="uploadsGrid" class="uploadsGrid"></div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="rightCol">
      <div class="card">
        <div class="panelTitle">
          <div class="t">Rank slots</div>
          <div class="pill" id="rankHint">Drop or tap</div>
        </div>
        <div class="divider"></div>
        <div id="rankSlots" class="rankSlots"></div>
      </div>

      <div class="card">
        <div class="panelTitle">
          <div class="t">Current cover</div>
          <div class="pill" id="queuePillTop">0 of 5</div>
        </div>
        <div class="divider"></div>

        <div id="currentCard" class="currentCard" draggable="false" aria-label="Current cover">
          <img id="currentImg" class="currentImg" alt="" />
          <div class="currentMeta">
            <div id="currentName" class="currentName">Hidden</div>
            <span class="pill" id="placeHint">Place it</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="stickyBar" id="stickyBar">
    <div class="stickyRow">
      <div class="stickyMsg" id="stickyMsg">Load images</div>
      <div class="pill" id="stickyPill">0 of 5 placed</div>
    </div>
  </div>

  <script>
    const BRAND_LOGO_SRC = "./bce-logo.jpeg";
    const BRAND_BANNER_SRC = "./bce-banner.png";

    const heroLogoEl = document.getElementById("heroLogo");
    const heroBannerEl = document.getElementById("heroBanner");
    heroLogoEl.src = BRAND_LOGO_SRC;
    heroBannerEl.style.backgroundImage = `url('${BRAND_BANNER_SRC}')`;

    const fileInput = document.getElementById("fileInput");
    const startBtn = document.getElementById("startBtn");
    const toggleControlsBtn = document.getElementById("toggleControlsBtn");
    const controlsBody = document.getElementById("controlsBody");
    const newRunBtn = document.getElementById("newRunBtn");
    const undoBtn = document.getElementById("undoBtn");
    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");

    const statusEl = document.getElementById("status");
    const loadedPill = document.getElementById("loadedPill");
    const uploadsCountEl = document.getElementById("uploadsCount");
    const uploadsGridEl = document.getElementById("uploadsGrid");

    const progressPill = document.getElementById("progressPill");
    const queuePill = document.getElementById("queuePill");
    const queuePillTop = document.getElementById("queuePillTop");
    const slotPill = document.getElementById("slotPill");
    const rankHintEl = document.getElementById("rankHint");

    const stickyBar = document.getElementById("stickyBar");
    const stickyMsg = document.getElementById("stickyMsg");
    const stickyPill = document.getElementById("stickyPill");

    const rankSlotsEl = document.getElementById("rankSlots");
    const currentCardEl = document.getElementById("currentCard");
    const currentImgEl = document.getElementById("currentImg");
    const currentNameEl = document.getElementById("currentName");
    const placeHintEl = document.getElementById("placeHint");

    let allImages = [];
    let pickedFive = [];
    let currentIndex = 0;
    let slots = [null, null, null, null, null];
    let history = [];

    function setStatus(text) { statusEl.textContent = text; }

    function setControlsOpen(isOpen) {
      controlsBody.classList.toggle("open", isOpen);
      toggleControlsBtn.textContent = isOpen ? "Less" : "More";
    }

    toggleControlsBtn.addEventListener("click", () => {
      const open = controlsBody.classList.contains("open");
      setControlsOpen(!open);
    });

    function clearUrls(list) {
      for (const item of list) {
        if (item && item.url) URL.revokeObjectURL(item.url);
      }
    }

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
      }
      return a;
    }

    function placedCount() { return slots.filter(Boolean).length; }

    function updateProgressUI() {
      const n = placedCount();
      progressPill.textContent = `${n} of 5 placed`;
      stickyPill.textContent = `${n} of 5 placed`;
      exportBtn.disabled = (n !== 5);
    }

    function updateQueueUI() {
      const shown = Math.min(currentIndex + 1, 5);
      queuePill.textContent = `${shown} of 5`;
      queuePillTop.textContent = `${shown} of 5`;
    }

    function renderUploadsGrid() {
      uploadsGridEl.innerHTML = "";
      for (const item of allImages) {
        const img = document.createElement("img");
        img.className = "uThumb";
        img.src = item.url;
        img.alt = "";
        uploadsGridEl.appendChild(img);
      }
      uploadsCountEl.textContent = `${allImages.length}`;
      loadedPill.textContent = `${allImages.length} loaded`;
    }

    function renderSlots() {
      rankSlotsEl.innerHTML = "";

      for (let i = 0; i < 5; i++) {
        const rankNum = i + 1;
        const slot = document.createElement("div");
        slot.className = "slot";
        if (slots[i]) slot.classList.add("filled");

        slot.addEventListener("click", () => {
          rankHintEl.textContent = `Rank ${rankNum}`;
          slotPill.textContent = `Rank ${rankNum}`;
          placeIntoSlot(i);
        });

        slot.addEventListener("dragover", (e) => {
          if (slots[i]) return;
          if (!currentCardEl.draggable) return;
          e.preventDefault();
          slot.classList.add("dropReady");
        });

        slot.addEventListener("dragleave", () => {
          slot.classList.remove("dropReady");
        });

        slot.addEventListener("drop", (e) => {
          e.preventDefault();
          slot.classList.remove("dropReady");
          placeIntoSlot(i);
        });

        const thumb = document.createElement("img");
        thumb.className = "slotThumb";
        if (slots[i]) { thumb.src = slots[i].url; }

        const text = document.createElement("div");
        text.className = "slotText";

        const rank = document.createElement("div");
        rank.className = "slotRank";
        rank.textContent = `Rank ${rankNum}`;

        const name = document.createElement("div");
        name.className = "slotName";
        name.textContent = "Hidden";

        const hint = document.createElement("div");
        hint.className = "slotHint";
        hint.textContent = slots[i] ? "Locked" : "Tap or drop here";

        text.appendChild(rank);
        text.appendChild(name);
        text.appendChild(hint);

        const right = document.createElement("div");
        right.className = "pill";
        right.textContent = slots[i] ? "Filled" : "Open";

        slot.appendChild(thumb);
        slot.appendChild(text);
        slot.appendChild(right);

        rankSlotsEl.appendChild(slot);
      }
    }

    function showCurrent() {
      const done = placedCount() === 5;

      if (done) {
        setStatus("Done");
        stickyMsg.textContent = "Done. Export ready.";
        currentCardEl.draggable = false;
        currentCardEl.classList.remove("dragging");
        currentImgEl.removeAttribute("src");
        currentImgEl.alt = "";
        currentImgEl.style.display = "none";
        currentNameEl.textContent = "Hidden";
        placeHintEl.textContent = "Export";
        return;
      }

      const item = pickedFive[currentIndex];
      if (!item) return;

      setStatus("Place your top 5");
      stickyMsg.textContent = "Place the current cover";

      currentImgEl.style.display = "block";
      currentImgEl.src = item.url;
      currentImgEl.alt = "";
      currentNameEl.textContent = "Hidden";
      placeHintEl.textContent = "Drag or tap a slot";
      currentCardEl.draggable = true;

      updateQueueUI();
    }

    function advance() {
      currentIndex += 1;
      showCurrent();
    }

    function placeIntoSlot(slotIndex) {
      if (slots[slotIndex]) return;
      if (placedCount() === 5) return;

      const item = pickedFive[currentIndex];
      if (!item) return;

      slots[slotIndex] = item;

      history.push({ slotIndex, item });
      undoBtn.disabled = (history.length === 0);

      renderSlots();
      updateProgressUI();

      advance();
    }

    function undoLast() {
      if (history.length === 0) return;

      const last = history.pop();
      slots[last.slotIndex] = null;

      if (currentIndex > 0) currentIndex -= 1;

      undoBtn.disabled = (history.length === 0);

      renderSlots();
      updateProgressUI();
      updateQueueUI();

      setStatus("Place your top 5");
      stickyMsg.textContent = "Place the current cover";

      showCurrent();
    }

    async function requestPortraitLock() {
      try {
        if (!screen.orientation || !screen.orientation.lock) return;
        await screen.orientation.lock("portrait");
      } catch (_) { }
    }

    function startRun() {
      history = [];
      undoBtn.disabled = true;

      pickedFive = shuffle(allImages).slice(0, 5);
      currentIndex = 0;
      slots = [null, null, null, null, null];

      stickyBar.style.display = "block";
      stickyMsg.textContent = "Place the current cover";

      setStatus("Place your top 5");
      newRunBtn.disabled = false;
      resetBtn.disabled = false;
      exportBtn.disabled = true;

      renderSlots();
      updateProgressUI();
      updateQueueUI();
      showCurrent();

      setControlsOpen(false);
    }

    function resetAll() {
      clearUrls(allImages);
      allImages = [];
      pickedFive = [];
      currentIndex = 0;
      slots = [null, null, null, null, null];
      history = [];

      fileInput.value = "";
      uploadsGridEl.innerHTML = "";

      rankSlotsEl.innerHTML = "";

      uploadsCountEl.textContent = "0";
      loadedPill.textContent = "0 loaded";
      progressPill.textContent = "0 of 5 placed";
      queuePill.textContent = "0 of 5";
      queuePillTop.textContent = "0 of 5";
      slotPill.textContent = "Drop or tap";
      rankHintEl.textContent = "Drop or tap";

      stickyBar.style.display = "none";
      stickyMsg.textContent = "Load images";
      stickyPill.textContent = "0 of 5 placed";

      setStatus("Load images");

      currentCardEl.draggable = false;
      currentImgEl.removeAttribute("src");
      currentImgEl.alt = "";
      currentImgEl.style.display = "none";
      currentNameEl.textContent = "Hidden";
      placeHintEl.textContent = "Place it";

      startBtn.disabled = true;
      toggleControlsBtn.disabled = true;
      newRunBtn.disabled = true;
      undoBtn.disabled = true;
      exportBtn.disabled = true;
      resetBtn.disabled = true;

      setControlsOpen(false);
    }

    function drawRoundedRect(ctx, x, y, w, h, r) {
      const rr = Math.min(r, w / 2, h / 2);
      ctx.beginPath();
      ctx.moveTo(x + rr, y);
      ctx.arcTo(x + w, y, x + w, y + h, rr);
      ctx.arcTo(x + w, y + h, x, y + h, rr);
      ctx.arcTo(x, y + h, x, y, rr);
      ctx.arcTo(x, y, x + w, y, rr);
      ctx.closePath();
    }

    function loadImageFromUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    function drawCoverContained(ctx, img, x, y, w, h) {
      const ir = img.width / img.height;
      const tr = w / h;
      let dw = w, dh = h, dx = x, dy = y;

      if (ir > tr) {
        dh = w / ir;
        dy = y + (h - dh) / 2;
      } else {
        dw = h * ir;
        dx = x + (w - dw) / 2;
      }
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    async function exportRanking() {
      if (placedCount() !== 5) return;

      exportBtn.disabled = true;
      exportBtn.textContent = "Exporting";
      setStatus("Exporting");
      stickyMsg.textContent = "Exporting image";

      try {
        const width = 1080;
        const height = 1920;
        const padding = 56;

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");

        const bg = ctx.createLinearGradient(0, 0, 0, height);
        bg.addColorStop(0, "#0b0c10");
        bg.addColorStop(1, "#141622");
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, width, height);

        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.font = "1000 64px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("BCE COMICS POD", padding, 120);

        ctx.fillStyle = "rgba(255,255,255,0.80)";
        ctx.font = "800 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("Blind Top 5", padding, 172);

        ctx.strokeStyle = "rgba(255,255,255,0.18)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, 206);
        ctx.lineTo(width - padding, 206);
        ctx.stroke();

        const areaTop = 250;
        const areaBottom = height - 70;
        const areaH = areaBottom - areaTop;
        const gap = 18;
        const rowH = Math.floor((areaH - gap * 4) / 5);

        for (let i = 0; i < 5; i++) {
          const item = slots[i];
          if (!item) continue;

          const y = areaTop + i * (rowH + gap);

          ctx.fillStyle = "rgba(15,17,32,0.98)";
          drawRoundedRect(ctx, padding, y, width - padding * 2, rowH, 22);
          ctx.fill();

          ctx.fillStyle = "rgba(255,255,255,0.92)";
          ctx.font = "1000 46px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillText(`${i + 1}`, padding + 22, y + 56);

          const img = await loadImageFromUrl(item.url);

          const imgX = padding + 90;
          const imgW = (width - padding * 2) - 110;
          const imgY = y + 14;
          const imgH = rowH - 28;

          ctx.save();
          drawRoundedRect(ctx, imgX, imgY, imgW, imgH, 18);
          ctx.clip();
          ctx.fillStyle = "#0b0c10";
          ctx.fillRect(imgX, imgY, imgW, imgH);
          drawCoverContained(ctx, img, imgX, imgY, imgW, imgH);
          ctx.restore();
        }

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png", 1.0));

        if (!blob) {
          const dataUrl = canvas.toDataURL("image/png");
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = "bce-top-5.png";
          document.body.appendChild(a);
          a.click();
          a.remove();
        } else {
          const file = new File([blob], "bce-top-5.png", { type: "image/png" });

          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: "BCE Comics Pod", text: "Blind Top 5" });
          } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "bce-top-5.png";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 2000);
          }
        }

        setStatus("Done");
        stickyMsg.textContent = "Done. Export ready.";
      } catch (e) {
        setStatus("Export failed");
        stickyMsg.textContent = "Export failed";
        alert("Export failed. Retry. If downloads are blocked, allow downloads for this site.");
      } finally {
        exportBtn.textContent = "Export";
        exportBtn.disabled = false;
      }
    }

    currentCardEl.addEventListener("dragstart", (e) => {
      if (!currentCardEl.draggable) {
        e.preventDefault();
        return;
      }
      currentCardEl.classList.add("dragging");
      e.dataTransfer.setData("text/plain", "current");
    });

    currentCardEl.addEventListener("dragend", () => {
      currentCardEl.classList.remove("dragging");
      for (const el of document.querySelectorAll(".slot")) el.classList.remove("dropReady");
    });

    fileInput.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);

      clearUrls(allImages);
      allImages = files.map((f, idx) => ({
        id: `${Date.now()}-${idx}`,
        name: f.name || `Image ${idx + 1}`,
        file: f,
        url: URL.createObjectURL(f)
      }));

      renderUploadsGrid();

      pickedFive = [];
      currentIndex = 0;
      slots = [null, null, null, null, null];
      history = [];
      undoBtn.disabled = true;

      renderSlots();
      updateProgressUI();

      currentCardEl.draggable = false;
      currentImgEl.removeAttribute("src");
      currentImgEl.alt = "";
      currentImgEl.style.display = "none";
      currentNameEl.textContent = "Hidden";
      placeHintEl.textContent = "Place it";

      stickyBar.style.display = "none";
      stickyMsg.textContent = "Load images";
      stickyPill.textContent = "0 of 5 placed";

      if (allImages.length >= 5) {
        startBtn.disabled = false;
        resetBtn.disabled = false;
        toggleControlsBtn.disabled = false;
        setStatus("Ready");
      } else {
        startBtn.disabled = true;
        resetBtn.disabled = (allImages.length === 0);
        toggleControlsBtn.disabled = (allImages.length === 0);
        setStatus(`Need 5. Loaded ${allImages.length}`);
      }

      newRunBtn.disabled = true;
      exportBtn.disabled = true;

      setControlsOpen(false);
    });

    startBtn.addEventListener("click", async () => {
      await requestPortraitLock();
      stickyBar.style.display = "block";
      startRun();
    });

    newRunBtn.addEventListener("click", async () => {
      await requestPortraitLock();
      if (allImages.length < 5) return;
      startRun();
    });

    undoBtn.addEventListener("click", undoLast);
    exportBtn.addEventListener("click", exportRanking);
    resetBtn.addEventListener("click", resetAll);

    resetAll();
  </script>
</body>
</html>
